<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Auditoría y Trámites - EPS CAJACOPI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Librerías de Firebase -->
    <script>
        // IMPORTANTE: Reemplaza esto con la configuración de tu propio proyecto de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAl4N-CBj4znQo0DhUQU3z4dSmTXjYRtxk",
            authDomain: "gestor-bitacora.firebaseapp.com",
            projectId: "gestor-bitacora",
            storageBucket: "gestor-bitacora.appspot.com",
            messagingSenderId: "551984065452",
            appId: "1:551984065452:web:771e275ed40ec67a2be809",
            measurementId: "G-FV7CHCETHW"
        };
        // El resto del código usará esta configuración. No necesitas tocar nada más abajo de esta línea.
        window.firebaseConfig = firebaseConfig;
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .chart-container { position: relative; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto; height: 320px; max-height: 350px; }
        @media (min-width: 768px) { .chart-container { height: 350px; max-height: 400px; } }
        .ips-list-container, #user-list, .window-notes-history { scrollbar-width: thin; scrollbar-color: #9ca3af #e5e7eb; }
        .ips-list-container::-webkit-scrollbar, #user-list::-webkit-scrollbar, .window-notes-history::-webkit-scrollbar { width: 6px; }
        .ips-list-container::-webkit-scrollbar-track, #user-list::-webkit-scrollbar-track, .window-notes-history::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; }
        .ips-list-container::-webkit-scrollbar-thumb, #user-list::-webkit-scrollbar-thumb, .window-notes-history::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; border: 2px solid #e5e7eb; }
        .chart-container canvas:hover, #ips-list li:hover { cursor: pointer; }
        .nav-link.active { background-color: #4f46e5; color: white; }
        .table-row-hover:hover { background-color: #f3f4f6; cursor: pointer; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .window-nav-link.active { background-color: #eef2ff; color: #4338ca; font-weight: 600; }
        .risk-btn-active { filter: brightness(1.1); border-width: 2px; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Pantalla de Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-900">Iniciar Sesión</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="text-sm font-medium text-gray-700">Usuario (email)</label>
                    <input id="username" name="username" type="email" required class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">Clave</label>
                    <input id="password" name="password" type="password" required class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                <button type="submit" class="w-full py-3 px-4 text-white bg-blue-600 rounded-md font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Ingresar
                </button>
            </form>
        </div>
    </div>

    <!-- Aplicación Principal (Oculta por defecto) -->
    <div id="main-app" class="hidden flex h-screen bg-gray-100">
        
        <!-- Modal para ver/editar detalles -->
        <div id="task-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
            <div id="modal-content" class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[70vh] transform scale-95 flex flex-col">
                <!-- Header del Modal -->
                <div class="flex justify-between items-center p-4 border-b border-gray-200 rounded-t-xl bg-gray-50 flex-shrink-0">
                    <div class="flex items-center space-x-3">
                        <span id="modal-status-indicator" class="h-4 w-4 rounded-full"></span>
                        <h3 class="text-lg font-bold text-gray-800" id="modal-title">Detalles del Trámite</h3>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <!-- Cuerpo del Modal con Navegación Lateral -->
                <div class="flex flex-grow overflow-hidden">
                    <aside class="w-48 bg-gray-100 p-4 border-r border-gray-200 flex-shrink-0">
                        <nav class="flex flex-col space-y-2">
                             <a href="#" onclick="handleWindowNav('info')" class="window-nav-link px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-200">Información General</a>
                             <a href="#" onclick="handleWindowNav('history')" class="window-nav-link px-3 py-2 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-200">Historial de Seguimiento</a>
                        </nav>
                    </aside>
                    <div class="flex-grow p-6 overflow-y-auto">
                        <div id="window-view-info" class="window-view">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><h4 class="font-semibold text-gray-500 text-sm mb-1">ID Paciente</h4><p id="modal-id-paciente" class="text-gray-800 text-lg"></p></div>
                                <div><h4 class="font-semibold text-gray-500 text-sm mb-1">Nombre Paciente</h4><p id="modal-nombre-paciente" class="text-gray-800 text-lg"></p></div>
                                <div><h4 class="font-semibold text-gray-500 text-sm mb-1">Tipo de Actividad</h4><p id="modal-tipo-actividad" class="text-gray-800 text-lg"></p></div>
                                <div><h4 class="font-semibold text-gray-500 text-sm mb-1">Nombre IPS</h4><p id="modal-nombre-ips" class="text-gray-800 text-lg"></p></div>
                                <div class="md:col-span-2"><h4 class="font-semibold text-gray-500 text-sm mb-1">Nombre Auditor</h4><p id="modal-nombre-auditor" class="text-gray-800 text-lg"></p></div>
                                <div class="bg-gray-100 p-3 rounded-md"><h4 class="font-semibold text-gray-500 text-sm mb-1">Fecha de Creación</h4><p id="modal-fecha-inicio" class="text-gray-800 text-lg"></p></div>
                                <div class="bg-gray-100 p-3 rounded-md"><h4 class="font-semibold text-gray-500 text-sm mb-1">Fecha Inicio Solicitud</h4><p id="modal-fecha-inicio-solicitud" class="text-gray-800 text-lg"></p></div>
                                <div class="bg-gray-100 p-3 rounded-md"><h4 class="font-semibold text-gray-500 text-sm mb-1">Fecha de Fin</h4><p id="modal-fecha-fin" class="text-gray-800 text-lg"></p></div>
                            </div>
                            <div class="mt-6"><h4 class="font-semibold text-gray-500 text-sm mb-1">Descripción Inicial</h4><p id="modal-descripcion" class="bg-gray-100 p-3 rounded-md text-gray-700 whitespace-pre-wrap"></p></div>
                        </div>
                        <div id="window-view-history" class="window-view hidden">
                             <div>
                                <h4 class="font-semibold text-gray-500 text-sm mb-2">Historial de Seguimiento</h4>
                                <div id="modal-notes-history" class="w-full h-48 bg-gray-50 border border-gray-200 rounded-md p-3 space-y-3 overflow-y-auto window-notes-history">
                                </div>
                            </div>
                            <div id="add-note-section" class="hidden mt-4">
                                <h4 class="font-semibold text-gray-500 text-sm mb-2">Añadir Nueva Nota</h4>
                                <form id="add-note-form">
                                    <textarea id="modal-new-note" class="w-full h-20 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Escriba aquí su nota de seguimiento..."></textarea>
                                    <button type="submit" class="mt-2 w-full px-5 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Agregar Nota</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menú Lateral -->
        <aside id="sidebar" class="w-64 bg-gray-800 text-white flex-col p-4 flex-shrink-0 z-30 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out flex">
            <h1 class="text-2xl font-bold text-white mb-8">Gestor App</h1>
            <nav class="flex-grow space-y-2">
                <a href="#" data-view="dashboard" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    Dashboard
                </a>
                <a href="#" data-view="table" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                     <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    Panel de Trámites
                </a>
                <a href="#" id="nav-add-tramite" data-view="add-tramite" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Nuevo Trámite
                </a>
                <a href="#" id="nav-export" data-view="export" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Exportar
                </a>
                <a href="#" id="nav-admin" data-view="admin" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A10.99 10.99 0 002.62 16m16.76 0a10.99 10.99 0 01-2.28 2.451M15 21a10.99 10.99 0 002.28-2.451m0 0a10.99 10.99 0 00-2.28-2.451M12 12a10.99 10.99 0 01-2.451-2.28m0 0a10.99 10.99 0 01-2.451 2.28m0 0A10.99 10.99 0 012.62 16m0 0a10.99 10.99 0 012.451-2.28m0 0a10.99 10.99 0 012.28-2.451"></path></svg>
                    Administración
                </a>
            </nav>
            <div class="mt-auto">
                <div class="text-left p-2 bg-gray-700 rounded-md">
                    <p id="user-display" class="font-semibold text-sm truncate"></p>
                    <p id="role-display" class="text-xs text-gray-400"></p>
                </div>
                <button onclick="handleLogout()" class="w-full mt-2 flex items-center px-4 py-2 rounded-md text-gray-300 hover:bg-red-600 hover:text-white transition-colors">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    Cerrar Sesión
                </button>
            </div>
        </aside>

        <!-- Overlay para menú móvil -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <!-- Área de Contenido Principal -->
        <div class="flex-1 flex flex-col relative overflow-hidden">
            <header class="bg-white shadow-sm md:hidden flex justify-between items-center p-4">
                 <button id="hamburger-btn" class="text-gray-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 class="text-lg font-bold">Gestor App</h1>
            </header>
            <main id="main-content" class="flex-1 p-6 lg:p-8 overflow-y-auto relative">
                
                <section id="dashboard-view" class="view">
                    <div class="text-center mb-8"><h2 class="text-3xl font-bold text-gray-900">Métricas y Estadísticas</h2><p class="mt-2 text-lg text-gray-600">Haz clic en los elementos del dashboard para filtrar el panel de trámites.</p></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-center items-center text-center"><h3 class="text-lg font-semibold text-gray-600">Total Trámites Finalizados</h3><p id="kpi-finalizados" class="text-5xl font-bold text-green-600 mt-2">0</p></div><div class="bg-white p-6 rounded-xl shadow-lg flex flex-col hover:bg-gray-50 transition-colors"><h3 class="text-lg font-semibold text-center text-gray-600 mb-4">IPS con Trámites Activos</h3><div id="ips-list-container" class="ips-list-container flex-grow overflow-y-auto pr-2 h-64 md:h-auto"><ul id="ips-list" class="space-y-3"></ul></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-xl shadow-lg hover:bg-gray-50 transition-colors"><h3 class="text-lg font-semibold text-center text-gray-600 mb-4">Actividades por Tipo</h3><div class="chart-container"><canvas id="type-chart"></canvas></div></div><div class="bg-white p-6 rounded-xl shadow-lg hover:bg-gray-50 transition-colors"><h3 class="text-lg font-semibold text-center text-gray-600 mb-4">Trámites por Estado</h3><div class="chart-container"><canvas id="status-chart"></canvas></div></div><div class="bg-white p-6 rounded-xl shadow-lg hover:bg-gray-50 transition-colors"><h3 class="text-lg font-semibold text-center text-gray-600 mb-4">Casos por Auditor</h3><div class="chart-container"><canvas id="auditor-chart"></canvas></div></div></div>
                </section>

                <section id="table-view" class="view hidden">
                    <!-- Filtros Activos -->
                    <section id="active-filters-section" class="hidden mb-6 bg-white p-4 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center flex-wrap gap-2" id="active-filters-list">
                                <h4 class="text-sm font-semibold text-gray-600">Filtros Activos:</h4>
                            </div>
                            <button onclick="clearFilters()" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex-shrink-0 ml-4">Limpiar Filtros</button>
                        </div>
                    </section>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-900">Panel de Trámites</h2>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Identificación</th>
                                        <th scope="col" class="px-6 py-3">Afiliado</th>
                                        <th scope="col" class="px-6 py-3">Tipo Actividad</th>
                                        <th scope="col" class="px-6 py-3">Prestador</th>
                                        <th scope="col" class="px-6 py-3">Fecha Inicio Solicitud</th>
                                        <th scope="col" class="px-6 py-3">Días en Trámite</th>
                                        <th scope="col" class="px-6 py-3">Estatus</th>
                                        <th scope="col" class="px-6 py-3">Responsable</th>
                                        <th scope="col" class="px-6 py-3">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tasks-table-body">
                                    <!-- Filas de la tabla se generarán aquí -->
                                </tbody>
                            </table>
                        </div>
                        <nav id="pagination-controls" class="flex justify-between items-center pt-4"></nav>
                    </div>
                </section>

                <section id="add-tramite-view" class="view hidden">
                     <div class="bg-white p-6 rounded-xl shadow-lg max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6">Añadir Nuevo Trámite</h2>
                        <form id="add-task-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="id_paciente" class="block text-sm font-medium text-gray-700">ID Paciente*</label>
                                    <input name="id_paciente" type="text" required class="mt-1 p-2 border rounded-md w-full">
                                </div>
                                <div>
                                    <label for="nombre_paciente" class="block text-sm font-medium text-gray-700">Nombre Paciente</label>
                                    <input name="nombre_paciente" type="text" class="mt-1 p-2 border rounded-md w-full">
                                </div>
                                <div>
                                    <label for="nombre_auditor" class="block text-sm font-medium text-gray-700">Nombre Auditor*</label>
                                    <input name="nombre_auditor" type="text" required class="mt-1 p-2 border rounded-md w-full">
                                </div>
                                <div>
                                    <label for="nombre_ips" class="block text-sm font-medium text-gray-700">Nombre IPS*</label>
                                    <input name="nombre_ips" type="text" required class="mt-1 p-2 border rounded-md w-full">
                                </div>
                                <div>
                                    <label for="fecha_inicio_solicitud" class="block text-sm font-medium text-gray-700">Fecha de Inicio de Solicitud*</label>
                                    <input name="fecha_inicio_solicitud" type="date" required class="mt-1 p-2 border rounded-md w-full">
                                </div>
                            </div>
                            <div>
                                <label for="tipo_actividad" class="block text-sm font-medium text-gray-700">Tipo de Actividad*</label>
                                <select name="tipo_actividad" required class="mt-1 p-2 border rounded-md w-full">
                                    <option value="">Seleccione Tipo de Actividad*</option>
                                    <option>Revisión Historia Clínica</option><option>Solicitud Oxígeno</option><option>Solicitud PHD</option><option>Solicitud Autorizaciones</option><option>Solicitud Historia Clínica</option><option>Emisión Concepto Pertinencia</option><option>Solicitud Ambulancia</option><option>Referencia</option><option>Contrareferencia</option><option>Otro</option>
                                </select>
                            </div>
                            <div>
                                <label for="descripcion_inicial" class="block text-sm font-medium text-gray-700">Descripción Inicial*</label>
                                <textarea name="descripcion_inicial" required class="mt-1 p-2 border rounded-md w-full h-24"></textarea>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="handleNavigation('dashboard')" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancelar</button>
                                <button type="submit" class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700">Guardar Trámite</button>
                            </div>
                        </form>
                     </div>
                </section>

                <section id="export-view" class="view hidden">
                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-4xl mx-auto">
                        <h2 class="text-2xl font-bold mb-6">Exportar Base de Datos</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div><label for="filter-month" class="block text-sm font-medium text-gray-700">Filtrar por Mes</label><select id="filter-month" class="mt-1 block w-full p-2 border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select></div>
                            <div><label for="filter-ips" class="block text-sm font-medium text-gray-700">Filtrar por Institución</label><select id="filter-ips" class="mt-1 block w-full p-2 border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select></div>
                            <div><label for="filter-auditor" class="block text-sm font-medium text-gray-700">Filtrar por Auditor</label><select id="filter-auditor" class="mt-1 block w-full p-2 border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select></div>
                            <button id="download-btn" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-all w-full h-10 flex items-center justify-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>Descargar CSV</button>
                        </div>
                    </div>
                </section>

                <section id="admin-view" class="view hidden">
                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-4xl mx-auto">
                         <h2 class="text-2xl font-bold mb-6">Panel de Administración</h2>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                             <div>
                                <h3 class="text-lg font-semibold mb-3">Crear Nuevo Usuario</h3>
                                <form id="create-user-form" class="space-y-4">
                                    <input name="new_username" type="email" placeholder="Email del usuario*" required class="w-full p-2 border rounded-md">
                                    <input name="new_password" type="password" placeholder="Clave (mínimo 6 caracteres)*" required class="w-full p-2 border rounded-md">
                                    <select name="new_role" class="w-full p-2 border rounded-md">
                                        <option value="auditor">Auditor</option>
                                        <option value="visualizador">Visualizador</option>
                                        <option value="admin">Administrador</option>
                                    </select>
                                    <div id="admin-error" class="text-red-500 text-sm hidden"></div>
                                    <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Crear Usuario</button>
                                </form>
                             </div>
                             <div>
                                <h3 class="text-lg font-semibold mb-3">Usuarios Existentes</h3>
                                <ul id="user-list" class="space-y-2 h-48 overflow-y-auto pr-2"></ul>
                             </div>
                         </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword, 
        signOut 
    } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        onSnapshot, 
        addDoc, 
        doc, 
        updateDoc, 
        deleteDoc,
        getDoc,
        setDoc,
        serverTimestamp,
        arrayUnion,
        Timestamp
    } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
    
    // --- INICIALIZACIÓN DE FIREBASE ---
    const app = initializeApp(window.firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const STATUSES = ["Iniciado", "En Trámite", "Finalizado", "Cancelado"];
    const STATUS_COLORS = {"Iniciado":{bg:"bg-orange-100",text:"text-orange-800",border:"border-orange-400",indicator:"bg-orange-500"},"En Trámite":{bg:"bg-blue-100",text:"text-blue-800",border:"border-blue-400",indicator:"bg-blue-500"},"Finalizado":{bg:"bg-green-100",text:"text-green-800",border:"border-green-400",indicator:"bg-green-500"},"Cancelado":{bg:"bg-red-100",text:"text-red-800",border:"border-red-400",indicator:"bg-red-500"}};

    let appState = {
        currentUser: null, // { uid, email, role }
        users: [], // { id, email, role }
        tasks: [], // { id, ...data }
        editingTaskId: null,
        filters: { ips: null, tipo_actividad: null, estado: null, auditor: null },
        pagination: { currentPage: 1, rowsPerPage: 10 },
        unsubscribeUsers: null,
        unsubscribeTasks: null,
    };

    let typeChartInstance = null;
    let statusChartInstance = null;
    let auditorChartInstance = null;

    // --- LÓGICA DE AUTENTICACIÓN Y ROLES ---

    onAuthStateChanged(auth, async (user) => {
        const loginError = document.getElementById('login-error');
        if (user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                appState.currentUser = { uid: user.uid, email: user.email, role: userDocSnap.data().role };
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.add('flex');
                document.getElementById('main-app').classList.remove('hidden');
                initializeListeners();
                setupEventListeners();
            } else {
                loginError.textContent = "Autenticación exitosa, pero no se encontró el rol del usuario en la base de datos. Contacte al administrador.";
                loginError.classList.remove('hidden');
                console.error("User document not found in Firestore for UID:", user.uid);
                await signOut(auth); // Log out the user to prevent a broken state
            }
        } else {
            appState.currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('main-app').classList.remove('flex');
            document.getElementById('login-screen').classList.remove('hidden');
            if (appState.unsubscribeUsers) appState.unsubscribeUsers();
            if (appState.unsubscribeTasks) appState.unsubscribeTasks();
        }
    });
    
    async function handleLogin(e) {
        e.preventDefault();
        const email = e.target.username.value;
        const password = e.target.password.value;
        const loginError = document.getElementById('login-error');
        loginError.classList.add('hidden'); // Hide previous errors
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            loginError.textContent = "Usuario o clave incorrectos.";
            loginError.classList.remove('hidden');
        }
    }

    window.handleLogout = function() {
        signOut(auth);
        document.getElementById('login-form').reset();
    }
    
    // --- LISTENERS DE FIRESTORE ---
    function initializeListeners() {
        if (appState.unsubscribeUsers) appState.unsubscribeUsers();
        if (appState.unsubscribeTasks) appState.unsubscribeTasks();

        if (appState.currentUser && appState.currentUser.role === 'admin') {
            const usersQuery = collection(db, "users");
            appState.unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
                appState.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminPanel();
            });
        }
        
        const tasksQuery = collection(db, "tasks");
        appState.unsubscribeTasks = onSnapshot(tasksQuery, (snapshot) => {
            appState.tasks = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                fecha_inicio: doc.data().fecha_inicio?.toDate(),
                fecha_inicio_solicitud: doc.data().fecha_inicio_solicitud?.toDate(),
                fecha_fin: doc.data().fecha_fin?.toDate()
            }));
            renderAppForRole();
        });
    }

    function renderAppForRole() {
        if (!appState.currentUser) return;
        const user = appState.currentUser;
        document.getElementById('user-display').textContent = user.email;
        document.getElementById('role-display').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1);
        
        const navAdmin = document.getElementById('nav-admin');
        const navAddTramite = document.getElementById('nav-add-tramite');
        const navExport = document.getElementById('nav-export');

        navAdmin.classList.add('hidden');
        navAddTramite.classList.add('hidden');
        navExport.classList.add('hidden');
        
        if (user.role === 'admin') navAdmin.classList.remove('hidden');
        if (user.role === 'auditor') {
            navAddTramite.classList.remove('hidden');
            navExport.classList.remove('hidden');
        }
        
        handleNavigation('dashboard');
        renderTasksView();
        updateDashboard();
        populateFilters();
        renderActiveFilters();
    }

    function renderAdminPanel() {
        const userList = document.getElementById('user-list');
        if (!userList) return;
        userList.innerHTML = '';
        appState.users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'bg-gray-100 p-2 rounded-md flex justify-between items-center';
            li.innerHTML = `<div><span class="font-medium">${user.email}</span><span class="text-xs text-gray-500 ml-2 capitalize">${user.role}</span></div>${user.email !== 'admin@admin.com' ? `<button onclick="handleDeleteUser('${user.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>` : ''}`;
            userList.appendChild(li);
        });
    }
    
    window.handleDeleteUser = async function(userId) {
        if (confirm("¿Estás seguro de que quieres eliminar este usuario de la base de datos de roles? La cuenta de autenticación no se eliminará.")) {
             await deleteDoc(doc(db, "users", userId));
        }
    }

    async function handleCreateUser(e) {
        e.preventDefault();
        const email = e.target.new_username.value;
        const password = e.target.new_password.value;
        const role = e.target.new_role.value;
        const adminError = document.getElementById('admin-error');
        
        try {
            // This approach is insecure for production. Use Cloud Functions for user creation.
            const tempApp = initializeApp(window.firebaseConfig, `secondary-${Date.now()}`);
            const tempAuth = getAuth(tempApp);
            const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
            await setDoc(doc(db, "users", userCredential.user.uid), { email, role });
            await signOut(tempAuth);
            
            adminError.classList.add('hidden');
            e.target.reset();
        } catch (error) {
            adminError.textContent = error.message;
            adminError.classList.remove('hidden');
        }
    }
    
    // --- LÓGICA DE LA APLICACIÓN PRINCIPAL ---

    window.handleDeleteTask = async function(taskId) {
        if (confirm("¿Estás seguro de que quieres eliminar este trámite?")) {
            await deleteDoc(doc(db, "tasks", taskId));
        }
    }

    function getFilteredTasks() {
        const { ips, tipo_actividad, estado, auditor } = appState.filters;
        return appState.tasks.filter(task => {
            const ipsMatch = !ips || task.nombre_ips === ips;
            const tipoMatch = !tipo_actividad || task.tipo_actividad === tipo_actividad;
            const estadoMatch = !estado || task.estado === estado;
            const auditorMatch = !auditor || task.nombre_auditor === auditor;
            return ipsMatch && tipoMatch && estadoMatch && auditorMatch;
        });
    }

    function renderTasksView() {
        const tableBody = document.getElementById('tasks-table-body');
        if (!tableBody) return;
        
        const tasksToRender = getFilteredTasks();
        
        // Paginación
        const { currentPage, rowsPerPage } = appState.pagination;
        const totalPages = Math.ceil(tasksToRender.length / rowsPerPage);
        const paginatedTasks = tasksToRender.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);

        tableBody.innerHTML = '';
        paginatedTasks.forEach(task => {
            const row = document.createElement('tr');
            row.className = 'bg-white border-b table-row-hover';
            row.onclick = () => openModal(task.id);

            const daysInProcess = task.fecha_inicio_solicitud ? Math.ceil(((task.fecha_fin || new Date()) - task.fecha_inicio_solicitud) / (1000 * 60 * 60 * 24)) : 'N/A';

            row.innerHTML = `
                <td class="px-6 py-4">${task.id_paciente || ''}</td>
                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${task.nombre_paciente || ''}</td>
                <td class="px-6 py-4">${task.tipo_actividad || ''}</td>
                <td class="px-6 py-4">${task.nombre_ips || ''}</td>
                <td class="px-6 py-4">${formatDate(task.fecha_inicio_solicitud)}</td>
                <td class="px-6 py-4">${daysInProcess} días</td>
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <div class="h-2.5 w-2.5 rounded-full ${STATUS_COLORS[task.estado]?.indicator || 'bg-gray-400'} mr-2"></div>
                        ${task.estado}
                    </div>
                </td>
                <td class="px-6 py-4">${task.nombre_auditor || ''}</td>
                <td class="px-6 py-4">${generateActionButtons(task)}</td>
            `;
            tableBody.appendChild(row);
        });
        
        renderPaginationControls(totalPages);
    }
    
    function renderPaginationControls(totalPages) {
        const container = document.getElementById('pagination-controls');
        container.innerHTML = '';
        if (totalPages <= 1) return;

        let buttons = '';
        for (let i = 1; i <= totalPages; i++) {
            const activeClass = i === appState.pagination.currentPage ? 'bg-blue-600 text-white' : 'bg-white text-gray-500 hover:bg-gray-100';
            buttons += `<button onclick="goToPage(${i})" class="px-3 py-1 border rounded-md ${activeClass}">${i}</button>`;
        }
        container.innerHTML = `<div class="flex space-x-2">${buttons}</div>`;
    }

    window.goToPage = function(page) {
        appState.pagination.currentPage = page;
        renderTasksView();
    }
    
    function generateActionButtons(task) {
        let buttons = '';
        const baseBtnClass = 'px-2 py-1 text-xs font-semibold rounded-md transition-colors';
        if (!appState.currentUser) return '';
        const userRole = appState.currentUser.role;
        if (userRole === 'auditor') {
            if (task.estado === 'Iniciado') buttons += `<button onclick="event.stopPropagation(); changeStatus('${task.id}', 'En Trámite')" class="${baseBtnClass} bg-blue-500 text-white hover:bg-blue-600">Poner en Trámite</button>`;
            if (task.estado !== 'Finalizado' && task.estado !== 'Cancelado') {
                buttons += `<button onclick="event.stopPropagation(); changeStatus('${task.id}', 'Finalizado')" class="${baseBtnClass} bg-green-500 text-white hover:bg-green-600">Finalizar</button>`;
                buttons += `<button onclick="event.stopPropagation(); changeStatus('${task.id}', 'Cancelado')" class="${baseBtnClass} bg-red-500 text-white hover:bg-red-600">Cancelar</button>`;
            }
        } else if (userRole === 'admin') {
            buttons += `<button onclick="event.stopPropagation(); handleDeleteTask('${task.id}')" class="${baseBtnClass} bg-gray-700 text-white hover:bg-gray-800">Eliminar Trámite</button>`;
        }
        return buttons || '<span class="text-xs text-gray-400">N/A</span>';
    }

    function updateDashboard() {
        const tasksToDisplay = getFilteredTasks();
        document.getElementById('kpi-finalizados').textContent = appState.tasks.filter(t => t.estado === 'Finalizado').length;
        const ipsList = document.getElementById('ips-list');
        ipsList.innerHTML = '';
        const activeTasks = appState.tasks.filter(t => t.estado !== 'Finalizado' && t.estado !== 'Cancelado');
        const ipsCounts = activeTasks.reduce((acc,task) => { 
            if (task.nombre_ips) {
                acc[task.nombre_ips] = (acc[task.nombre_ips] || 0) + 1;
            }
            return acc; 
        }, {});
        if(Object.keys(ipsCounts).length === 0) ipsList.innerHTML = '<li class="text-center text-gray-500">No hay trámites activos.</li>';
        else Object.entries(ipsCounts).sort((a,b) => b[1] - a[1]).forEach(([ips, count]) => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg hover:bg-gray-200 transition-colors';
            li.onclick = () => setFilter('ips', ips);
            li.innerHTML = `<span class="text-gray-700 font-medium">${ips}</span><span class="font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full text-sm">${count}</span>`;
            ipsList.appendChild(li);
        });
        const typeCounts = tasksToDisplay.reduce((acc, task) => { acc[task.tipo_actividad] = (acc[task.tipo_actividad] || 0) + 1; return acc; }, {});
        if(typeChartInstance) typeChartInstance.destroy();
        typeChartInstance = new Chart(document.getElementById('type-chart'), { type: 'doughnut', data: { labels: Object.keys(typeCounts), datasets: [{ data: Object.values(typeCounts), backgroundColor: ['#3b82f6','#10b981','#f97316','#8b5cf6','#ec4899','#f59e0b','#ef4444','#6b7280', '#14b8a6', '#d946ef'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, onClick: (evt, elements) => { if (elements.length > 0) { const clickedLabel = typeChartInstance.data.labels[elements[0].index]; setFilter('tipo_actividad', clickedLabel); } }, plugins: { legend: { position: 'bottom' } } } });
        const statusCounts = tasksToDisplay.reduce((acc, status) => { acc[status.estado] = (acc[status.estado] || 0) + 1; return acc; }, {});
        if(statusChartInstance) statusChartInstance.destroy();
        statusChartInstance = new Chart(document.getElementById('status-chart'), { type: 'bar', data: { labels: STATUSES, datasets: [{ label: 'Nº de Trámites', data: STATUSES.map(s => statusCounts[s] || 0), backgroundColor: Object.values(STATUS_COLORS).map(c => c.indicator.replace('bg-', '#').replace('-500', '')), borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', onClick: (evt, elements) => { if (elements.length > 0) { const clickedLabel = statusChartInstance.data.labels[elements[0].index]; setFilter('estado', clickedLabel); } }, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } } });
        const auditorCounts = tasksToDisplay.reduce((acc, task) => { 
            if (task.nombre_auditor) {
                acc[task.nombre_auditor] = (acc[task.nombre_auditor] || 0) + 1;
            }
            return acc; 
        }, {});
        if(auditorChartInstance) auditorChartInstance.destroy();
        auditorChartInstance = new Chart(document.getElementById('auditor-chart'), { type: 'bar', data: { labels: Object.keys(auditorCounts), datasets: [{ label: 'Nº de Casos', data: Object.values(auditorCounts), backgroundColor: '#6366f1', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, onClick: (evt, elements) => { if (elements.length > 0) { const clickedLabel = auditorChartInstance.data.labels[elements[0].index]; setFilter('auditor', clickedLabel); } }, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
    }

    window.toggleForm = function() { handleNavigation('add-tramite'); }

    async function handleAddTask(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const fechaInicioSolicitud = formData.get('fecha_inicio_solicitud');
        const newTask = { 
            id_paciente: formData.get('id_paciente'), 
            nombre_paciente: formData.get('nombre_paciente') || 'N/A', 
            nombre_auditor: formData.get('nombre_auditor'), 
            nombre_ips: formData.get('nombre_ips'), 
            tipo_actividad: formData.get('tipo_actividad'), 
            descripcion_inicial: formData.get('descripcion_inicial'), 
            estado: 'Iniciado', 
            fecha_inicio: serverTimestamp(),
            fecha_inicio_solicitud: fechaInicioSolicitud ? Timestamp.fromDate(new Date(fechaInicioSolicitud)) : null,
            fecha_fin: null, 
            notas_seguimiento: [] 
        };
        await addDoc(collection(db, 'tasks'), newTask);
        e.target.reset();
        handleNavigation('table');
    }

    window.changeStatus = async function(taskId, newStatus) {
        const taskRef = doc(db, "tasks", taskId);
        const updateData = { estado: newStatus };
        if (newStatus === 'Finalizado' || newStatus === 'Cancelado') {
            updateData.fecha_fin = serverTimestamp();
        } else {
            updateData.fecha_fin = null;
        }
        await updateDoc(taskRef, updateData);
    }
    
    // --- LÓGICA DE FILTROS Y NAVEGACIÓN ---
    window.handleNavigation = function(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        const targetView = document.getElementById(`${viewId}-view`);
        if(targetView) targetView.classList.remove('hidden');
        
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        const targetLink = document.querySelector(`.nav-link[data-view="${viewId}"]`);
        if (targetLink) targetLink.classList.add('active');
    }

    window.setFilter = function(key, value) {
        appState.filters[key] = value;
        handleNavigation('table');
        renderActiveFilters();
    }

    window.clearFilters = function() {
        appState.filters = { ips: null, tipo_actividad: null, estado: null, auditor: null };
        renderTasksView();
        renderActiveFilters();
    }

    function renderActiveFilters() {
        const container = document.getElementById('active-filters-section');
        const list = document.getElementById('active-filters-list');
        list.innerHTML = '<h4 class="text-sm font-semibold text-gray-600">Filtros Activos:</h4>';
        const activeFilters = Object.entries(appState.filters).filter(([key, value]) => value !== null);
        if (activeFilters.length === 0) { container.classList.add('hidden'); return; }
        container.classList.remove('hidden');
        activeFilters.forEach(([key, value]) => {
            const filterTag = document.createElement('span');
            filterTag.className = 'bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full flex items-center';
            let keyText = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            filterTag.innerHTML = `<span>${keyText}: ${value}</span><button onclick="clearFilter('${key}')" class="ml-1.5 text-blue-500 hover:text-blue-700">&times;</button>`;
            list.appendChild(filterTag);
        });
    }

    window.clearFilter = function(key) { appState.filters[key] = null; renderTasksView(); renderActiveFilters(); }

    // --- LÓGICA DE VENTANAS ---
    window.openModal = function(taskId) {
        const modal = document.getElementById('task-modal');
        const task = appState.tasks.find(t => t.id === taskId);
        if (!task) return;

        appState.editingTaskId = taskId;
        
        document.getElementById('modal-status-indicator').className = `h-4 w-4 rounded-full ${STATUS_COLORS[task.estado].indicator}`;
        document.getElementById('modal-title').textContent = `Detalles: ${task.tipo_actividad}`;
        document.getElementById('modal-id-paciente').textContent = task.id_paciente;
        document.getElementById('modal-nombre-paciente').textContent = task.nombre_paciente;
        document.getElementById('modal-nombre-auditor').textContent = task.nombre_auditor;
        document.getElementById('modal-nombre-ips').textContent = task.nombre_ips;
        document.getElementById('modal-tipo-actividad').textContent = task.tipo_actividad;
        document.getElementById('modal-fecha-inicio').textContent = formatDate(task.fecha_inicio);
        document.getElementById('modal-fecha-fin').textContent = task.fecha_fin ? formatDate(task.fecha_fin) : 'Aún en curso';
        document.getElementById('modal-descripcion').textContent = task.descripcion_inicial;
        
        renderNotesHistory(task.notas_seguimiento);
        
        const addNoteSection = document.getElementById('add-note-section');
        if(appState.currentUser.role === 'auditor') {
            addNoteSection.classList.remove('hidden');
        } else {
            addNoteSection.classList.add('hidden');
        }

        handleWindowNav('info'); // Set initial view
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }, 10);
    }
    
    window.handleWindowNav = function(viewId) {
        document.querySelectorAll('#modal-content .window-view').forEach(v => v.classList.add('hidden'));
        const targetView = document.getElementById(`window-view-${viewId}`);
        if (targetView) targetView.classList.remove('hidden');

        document.querySelectorAll('#modal-content .window-nav-link').forEach(l => l.classList.remove('active'));
        const targetLink = document.querySelector(`#modal-content .window-nav-link[onclick="handleWindowNav('${viewId}')"]`);
        if (targetLink) targetLink.classList.add('active');
    }

    function renderNotesHistory(notes) {
        const historyContainer = document.getElementById('modal-notes-history');
        historyContainer.innerHTML = '';
        if (notes && notes.length > 0) {
            notes.slice().reverse().forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'bg-white p-2 rounded-md border border-gray-200';
                noteEl.innerHTML = `<p class="text-gray-800 text-sm">${note.text}</p><p class="text-xs text-gray-500 mt-1 text-right">-- ${note.author} @ ${formatDate(new Date(note.date))}</p>`;
                historyContainer.appendChild(noteEl);
            });
        } else {
            historyContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">No hay notas de seguimiento.</p>';
        }
    }

    async function handleAddNote(e) {
        e.preventDefault();
        if(!appState.editingTaskId) return;
        const newNoteText = document.getElementById('modal-new-note').value.trim();
        if (newNoteText) {
            const newNote = { text: newNoteText, author: appState.currentUser.email, date: new Date().toISOString() };
            const taskRef = doc(db, "tasks", appState.editingTaskId);
            await updateDoc(taskRef, {
                notas_seguimiento: arrayUnion(newNote)
            });
            document.getElementById('modal-new-note').value = '';
        }
    }

    window.closeModal = function() {
        const modal = document.getElementById('task-modal');
        appState.editingTaskId = null; 
        modal.classList.add('opacity-0'); 
        modal.querySelector('.modal-content').classList.add('scale-95'); 
        setTimeout(() => { modal.classList.add('hidden'); }, 250);
    }
    
    function formatDate(date) { if(!date) return 'N/A'; return new Date(date).toLocaleString('es-CO', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }
    
    function formatNotesForCSV(notes) {
        if (!notes || notes.length === 0) return "";
        return notes.map(note => `(${formatDate(new Date(note.date))} por ${note.author}): ${(note.text || '').replace(/"/g, '""').replace(/\r?\n/g, " ")}`).join(' | ');
    }

    function formatDateForCSV(date) { if(!date) return ''; return new Date(date).toISOString(); }

    function populateFilters() {
        const monthFilter = document.getElementById('filter-month');
        const ipsFilter = document.getElementById('filter-ips');
        const auditorFilter = document.getElementById('filter-auditor');
        const months = ["Todos", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        monthFilter.innerHTML = months.map((month, index) => `<option value="${index === 0 ? 'all' : index-1}">${month}</option>`).join('');
        const allIps = [...new Set(appState.tasks.map(task => task.nombre_ips).filter(Boolean))];
        ipsFilter.innerHTML = '<option value="all">Todas</option>' + allIps.map(ips => `<option value="${ips}">${ips}</option>`).join('');
        const allAuditors = [...new Set(appState.tasks.map(task => task.nombre_auditor).filter(Boolean))];
        auditorFilter.innerHTML = '<option value="all">Todos</option>' + allAuditors.map(auditor => `<option value="${auditor}">${auditor}</option>`).join('');
    }

    function downloadCSV() {
        const month = document.getElementById('filter-month').value; const ips = document.getElementById('filter-ips').value; const auditor = document.getElementById('filter-auditor').value;
        let filteredTasks = appState.tasks.filter(task => { const taskMonth = new Date(task.fecha_inicio).getMonth(); const monthMatch = (month === 'all') || (taskMonth == month); const ipsMatch = (ips === 'all') || (task.nombre_ips === ips); const auditorMatch = (auditor === 'all') || (task.nombre_auditor === auditor); return monthMatch && ipsMatch && auditorMatch; });
        if(filteredTasks.length === 0) { alert("No hay datos que coincidan con los filtros seleccionados."); return; }
        const headers = ["ID Trámite", "ID Paciente", "Nombre Paciente", "Nombre Auditor", "Nombre IPS", "Tipo Actividad", "Descripción Inicial", "Estado", "Fecha Creación", "Fecha Inicio Solicitud", "Fecha Fin", "Notas Seguimiento", "Tipo de Riesgo"];
        const csvRows = [headers.join(',')];
        filteredTasks.forEach(task => { 
            let riskTypes = [];
            if (task.riesgoSalud) riskTypes.push("Riesgo en Salud");
            if (task.riesgoJuridico) riskTypes.push("Riesgo Jurídico");

            const values = [
                task.id, 
                task.id_paciente, 
                `"${(task.nombre_paciente || '').replace(/"/g, '""')}"`, 
                `"${(task.nombre_auditor || '').replace(/"/g, '""')}"`, 
                `"${(task.nombre_ips || '').replace(/"/g, '""')}"`, 
                task.tipo_actividad, 
                `"${(task.descripcion_inicial || '').replace(/\r?\n/g, " ").replace(/"/g, '""')}"`, 
                task.estado, 
                formatDateForCSV(task.fecha_inicio),
                formatDateForCSV(task.fecha_inicio_solicitud),
                formatDateForCSV(task.fecha_fin), 
                `"${formatNotesForCSV(task.notas_seguimiento)}"`,
                `"${riskTypes.join(' | ')}"`
            ]; 
            csvRows.push(values.join(',')); 
        });
        const csvString = csvRows.join('\n'); const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a'); const url = URL.createObjectURL(blob); link.setAttribute('href', url); link.setAttribute('download', 'reporte_tramites.csv'); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
    
    function setupEventListeners() {
        const createUserForm = document.getElementById('create-user-form');
        if (createUserForm) createUserForm.addEventListener('submit', handleCreateUser);
        
        const downloadBtn = document.getElementById('download-btn');
        if (downloadBtn) downloadBtn.addEventListener('click', downloadCSV);

        const addNoteForm = document.getElementById('add-note-form');
        if (addNoteForm) addNoteForm.addEventListener('submit', (e) => handleAddNote(e));

        const addTaskForm = document.getElementById('add-task-form');
        if (addTaskForm) addTaskForm.addEventListener('submit', handleAddTask);

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                handleNavigation(e.currentTarget.dataset.view);
            });
        });

        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');

        hamburgerBtn.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        });
        overlay.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleLogin);
    });
</script>
</body>
</html>
