<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Auditoría y Trámites - EPS CAJACOPI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Librerías de Firebase -->
    <script>
        // IMPORTANTE: Reemplaza esto con la configuración de tu propio proyecto de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAl4N-CBj4znQo0DhUQU3z4dSmTXjYRtxk",
            authDomain: "gestor-bitacora.firebaseapp.com",
            projectId: "gestor-bitacora",
            storageBucket: "gestor-bitacora.appspot.com",
            messagingSenderId: "551984065452",
            appId: "1:551984065452:web:771e275ed40ec67a2be809",
            measurementId: "G-FV7CHCETHW"
        };
        // El resto del código usará esta configuración. No necesitas tocar nada más abajo de esta línea.
        window.firebaseConfig = firebaseConfig;
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Neutral Sage -->
    <!-- Application Structure Plan: Se ha implementado un sistema de autenticación basado en roles que precede a la aplicación principal. La estructura ahora consta de una pantalla de inicio de sesión y, una vez autenticado, un dashboard interactivo cuya funcionalidad se adapta al rol del usuario (Admin, Auditor, Visualizador). El administrador tiene un panel de gestión de usuarios, el auditor tiene la funcionalidad completa de gestión de trámites y el visualizador tiene acceso de solo lectura. Esta arquitectura segmenta el acceso y las capacidades, mejorando la seguridad y la pertinencia de la interfaz para cada tipo de usuario. -->
    <!-- Visualization & Content Choices: Se mantienen las visualizaciones del dashboard y el Kanban. La novedad es la adición de una pantalla de login y un panel de administración para el rol 'admin'. El acceso a funcionalidades como la creación de trámites, la edición de notas, el cambio de estado y la exportación de CSV se habilita o deshabilita dinámicamente con JavaScript en función del rol del usuario, en lugar de crear vistas separadas. Esto mantiene una base de código única y simplifica la gestión del estado. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .chart-container { position: relative; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto; height: 320px; max-height: 350px; }
        @media (min-width: 768px) { .chart-container { height: 350px; max-height: 400px; } }
        .kanban-column, .ips-list-container, #user-list, #modal-notes-history { scrollbar-width: thin; scrollbar-color: #9ca3af #e5e7eb; }
        .kanban-column::-webkit-scrollbar, .ips-list-container::-webkit-scrollbar, #user-list::-webkit-scrollbar, #modal-notes-history::-webkit-scrollbar { width: 6px; }
        .kanban-column::-webkit-scrollbar-track, .ips-list-container::-webkit-scrollbar-track, #user-list::-webkit-scrollbar-track, #modal-notes-history::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; }
        .kanban-column::-webkit-scrollbar-thumb, .ips-list-container::-webkit-scrollbar-thumb, #user-list::-webkit-scrollbar-thumb, #modal-notes-history::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; border: 2px solid #e5e7eb; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .chart-container canvas:hover, #ips-list li:hover { cursor: pointer; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Pantalla de Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-900">Iniciar Sesión</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="text-sm font-medium text-gray-700">Usuario (email)</label>
                    <input id="username" name="username" type="email" required class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">Clave</label>
                    <input id="password" name="password" type="password" required class="mt-1 w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                <button type="submit" class="w-full py-3 px-4 text-white bg-blue-600 rounded-md font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Ingresar
                </button>
            </form>
        </div>
    </div>

    <!-- Aplicación Principal (Oculta por defecto) -->
    <div id="main-app" class="hidden">
        <!-- Modal para ver/editar detalles -->
        <div id="task-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
            <div id="modal-content" class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl transform scale-95 flex flex-col">
                <!-- Header del Modal -->
                <div class="flex justify-between items-center p-5 border-b border-gray-200 rounded-t-xl bg-gray-50">
                    <div class="flex items-center space-x-3">
                        <span id="modal-status-indicator" class="h-4 w-4 rounded-full"></span>
                        <h3 class="text-xl font-bold text-gray-800" id="modal-title">Detalles del Trámite</h3>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <!-- Cuerpo del Modal -->
                <div class="p-6 space-y-6 flex-grow overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><h4 class="font-semibold text-gray-500 text-sm mb-1">ID Paciente</h4><p id="modal-id-paciente" class="text-gray-800 text-lg"></p></div>
                        <div><h4 class="font-semibold text-gray-500 text-sm mb-1">Nombre Paciente</h4><p id="modal-nombre-paciente" class="text-gray-800 text-lg"></p></div>
                        <div><h4 class="font-semibold text-gray-500 text-sm mb-1">Tipo de Actividad</h4><p id="modal-tipo-actividad" class="text-gray-800 text-lg"></p></div>
                        <div><h4 class="font-semibold text-gray-500 text-sm mb-1">Nombre IPS</h4><p id="modal-nombre-ips" class="text-gray-800 text-lg"></p></div>
                        <div class="md:col-span-2"><h4 class="font-semibold text-gray-500 text-sm mb-1">Nombre Auditor</h4><p id="modal-nombre-auditor" class="text-gray-800 text-lg"></p></div>
                        <div class="bg-gray-100 p-3 rounded-md"><h4 class="font-semibold text-gray-500 text-sm mb-1">Fecha de Inicio</h4><p id="modal-fecha-inicio" class="text-gray-800 text-lg"></p></div>
                        <div class="bg-gray-100 p-3 rounded-md"><h4 class="font-semibold text-gray-500 text-sm mb-1">Fecha de Fin</h4><p id="modal-fecha-fin" class="text-gray-800 text-lg"></p></div>
                    </div>
                    <div><h4 class="font-semibold text-gray-500 text-sm mb-1">Descripción Inicial</h4><p id="modal-descripcion" class="bg-gray-100 p-3 rounded-md text-gray-700 whitespace-pre-wrap"></p></div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-500 text-sm mb-2">Historial de Seguimiento</h4>
                        <div id="modal-notes-history" class="w-full h-32 bg-gray-50 border border-gray-200 rounded-md p-3 space-y-3 overflow-y-auto">
                            <!-- Las notas de seguimiento se renderizarán aquí -->
                        </div>
                    </div>

                    <div id="add-note-section" class="hidden">
                        <h4 class="font-semibold text-gray-500 text-sm mb-2">Añadir Nueva Nota</h4>
                        <form id="add-note-form">
                            <textarea id="modal-new-note" class="w-full h-20 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Escriba aquí su nota de seguimiento..."></textarea>
                            <button type="submit" class="mt-2 w-full px-5 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Agregar Nota</button>
                        </form>
                    </div>

                </div>
                <!-- Footer del Modal -->
                <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end">
                    <button onclick="closeModal()" class="px-5 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">Cerrar</button>
                </div>
            </div>
        </div>
        
        <!-- Contenido Principal de la APP -->
        <div class="min-h-screen">
            <header class="bg-white shadow-sm sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Gestor de Auditoría y Trámites</h1>
                    <div class="flex items-center space-x-4">
                        <div class="text-right"><p id="user-display" class="font-semibold text-gray-800"></p><p id="role-display" class="text-sm text-gray-500"></p></div>
                        <button id="add-tramite-btn" onclick="toggleForm()" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-all flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span>Nuevo Trámite</span>
                        </button>
                        <button onclick="handleLogout()" class="text-gray-500 hover:text-red-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                    </div>
                </div>
            </header>

            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                
                <div id="add-task-form-container" class="hidden mb-8"><div class="bg-white p-6 rounded-xl shadow-lg"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Añadir Nuevo Trámite</h2><button onclick="toggleForm()" class="text-gray-400 hover:text-gray-600">&times;</button></div><form id="add-task-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input name="id_paciente" type="text" placeholder="ID Paciente*" required class="p-2 border rounded-md w-full"><input name="nombre_paciente" type="text" placeholder="Nombre Paciente" class="p-2 border rounded-md w-full"><input name="nombre_auditor" type="text" placeholder="Nombre Auditor*" required class="p-2 border rounded-md w-full"><input name="nombre_ips" type="text" placeholder="Nombre IPS*" required class="p-2 border rounded-md w-full"></div><select name="tipo_actividad" required class="p-2 border rounded-md w-full"><option value="">Seleccione Tipo de Actividad*</option><option>Revisión Historia Clínica</option><option>Solicitud Oxígeno</option><option>Solicitud PHD</option><option>Solicitud Autorizaciones</option><option>Solicitud Historia Clínica</option><option>Emisión Concepto Pertinencia</option><option>Solicitud Ambulancia</option><option>Otro</option></select><textarea name="descripcion_inicial" placeholder="Descripción Inicial*" required class="p-2 border rounded-md w-full h-24"></textarea><div class="flex justify-end space-x-3"><button type="button" onclick="toggleForm()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancelar</button><button type="submit" class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700">Guardar Trámite</button></div></form></div></div>
                
                <!-- Panel de Administración -->
                <section id="admin-panel" class="hidden mb-8 bg-white p-6 rounded-xl shadow-lg">
                     <h2 class="text-xl font-bold mb-4 text-gray-800">Panel de Administración</h2>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                         <div>
                            <h3 class="text-lg font-semibold mb-3">Crear Nuevo Usuario</h3>
                            <form id="create-user-form" class="space-y-4">
                                <input name="new_username" type="email" placeholder="Email del usuario*" required class="w-full p-2 border rounded-md">
                                <input name="new_password" type="password" placeholder="Clave (mínimo 6 caracteres)*" required class="w-full p-2 border rounded-md">
                                <select name="new_role" class="w-full p-2 border rounded-md">
                                    <option value="auditor">Auditor</option>
                                    <option value="visualizador">Visualizador</option>
                                    <option value="admin">Administrador</option>
                                </select>
                                <div id="admin-error" class="text-red-500 text-sm hidden"></div>
                                <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Crear Usuario</button>
                            </form>
                         </div>
                         <div>
                            <h3 class="text-lg font-semibold mb-3">Usuarios Existentes</h3>
                            <ul id="user-list" class="space-y-2 h-48 overflow-y-auto pr-2"></ul>
                         </div>
                     </div>
                </section>

                <section id="export-section" class="mb-8 bg-white p-6 rounded-xl shadow-lg"><h2 class="text-xl font-bold mb-4 text-gray-800">Exportar Base de Datos</h2><div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end"><div><label for="filter-month" class="block text-sm font-medium text-gray-700">Filtrar por Mes</label><select id="filter-month" class="mt-1 block w-full p-2 border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select></div><div><label for="filter-ips" class="block text-sm font-medium text-gray-700">Filtrar por Institución</label><select id="filter-ips" class="mt-1 block w-full p-2 border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select></div><div><label for="filter-auditor" class="block text-sm font-medium text-gray-700">Filtrar por Auditor</label><select id="filter-auditor" class="mt-1 block w-full p-2 border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select></div><button id="download-btn" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-all w-full h-10 flex items-center justify-center"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>Descargar CSV</button></div></section>
                <section id="dashboard" class="mb-8"><div class="text-center mb-8"><h2 class="text-3xl font-bold text-gray-900">Métricas y Estadísticas</h2><p class="mt-2 text-lg text-gray-600">Haz clic en los elementos del dashboard para filtrar el panel de trámites.</p></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-center items-center text-center"><h3 class="text-lg font-semibold text-gray-600">Total Trámites Finalizados</h3><p id="kpi-finalizados" class="text-5xl font-bold text-green-600 mt-2">0</p></div><div class="bg-white p-6 rounded-xl shadow-lg flex flex-col hover:bg-gray-50 transition-colors"><h3 class="text-lg font-semibold text-center text-gray-600 mb-4">IPS con Trámites Activos</h3><div id="ips-list-container" class="ips-list-container flex-grow overflow-y-auto pr-2 h-64 md:h-auto"><ul id="ips-list" class="space-y-3"></ul></div></div></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-xl shadow-lg hover:bg-gray-50 transition-colors"><h3 class="text-lg font-semibold text-center text-gray-600 mb-4">Actividades por Tipo</h3><div class="chart-container"><canvas id="type-chart"></canvas></div></div><div class="bg-white p-6 rounded-xl shadow-lg hover:bg-gray-50 transition-colors"><h3 class="text-lg font-semibold text-center text-gray-600 mb-4">Trámites por Estado</h3><div class="chart-container"><canvas id="status-chart"></canvas></div></div><div class="bg-white p-6 rounded-xl shadow-lg hover:bg-gray-50 transition-colors"><h3 class="text-lg font-semibold text-center text-gray-600 mb-4">Casos por Auditor</h3><div class="chart-container"><canvas id="auditor-chart"></canvas></div></div></div></section>
                
                <!-- Filtros Activos -->
                <section id="active-filters-section" class="hidden mb-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-wrap gap-2" id="active-filters-list">
                            <h4 class="text-sm font-semibold text-gray-600">Filtros Activos:</h4>
                            <!-- Las etiquetas de filtros se insertarán aquí -->
                        </div>
                        <button onclick="clearFilters()" class="text-sm text-blue-600 hover:text-blue-800 font-semibold flex-shrink-0 ml-4">Limpiar Filtros</button>
                    </div>
                </section>
                
                <section id="kanban-board"><div class="text-center mb-8"><h2 class="text-3xl font-bold text-gray-900">Panel de Trámites</h2><p class="mt-2 text-lg text-gray-600">Gestiona activamente cada trámite a través de las diferentes fases de su ciclo de vida.</p></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="kanban-columns-container"></div></section>
            </main>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword, 
        signOut 
    } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        onSnapshot, 
        addDoc, 
        doc, 
        updateDoc, 
        deleteDoc,
        getDoc,
        setDoc,
        serverTimestamp,
        arrayUnion
    } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
    
    // --- INICIALIZACIÓN DE FIREBASE ---
    const app = initializeApp(window.firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const STATUSES = ["Iniciado", "En Trámite", "Finalizado", "Cancelado"];
    const STATUS_COLORS = {"Iniciado":{bg:"bg-orange-100",text:"text-orange-800",border:"border-orange-400",indicator:"bg-orange-500"},"En Trámite":{bg:"bg-blue-100",text:"text-blue-800",border:"border-blue-400",indicator:"bg-blue-500"},"Finalizado":{bg:"bg-green-100",text:"text-green-800",border:"border-green-400",indicator:"bg-green-500"},"Cancelado":{bg:"bg-red-100",text:"text-red-800",border:"border-red-400",indicator:"bg-red-500"}};

    let appState = {
        currentUser: null, // { uid, email, role }
        users: [], // { id, email, role }
        tasks: [], // { id, ...data }
        editingTaskId: null,
        filters: { ips: null, tipo_actividad: null, estado: null, auditor: null },
        unsubscribeUsers: null,
        unsubscribeTasks: null,
    };

    let typeChartInstance = null;
    let statusChartInstance = null;
    let auditorChartInstance = null;

    // --- LÓGICA DE AUTENTICACIÓN Y ROLES ---

    onAuthStateChanged(auth, async (user) => {
        const loginError = document.getElementById('login-error');
        if (user) {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                appState.currentUser = { uid: user.uid, email: user.email, role: userDocSnap.data().role };
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                initializeListeners();
            } else {
                loginError.textContent = "Autenticación exitosa, pero no se encontró el rol del usuario en la base de datos. Contacte al administrador.";
                loginError.classList.remove('hidden');
                console.error("User document not found in Firestore for UID:", user.uid);
                await signOut(auth); // Log out the user to prevent a broken state
            }
        } else {
            appState.currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            if (appState.unsubscribeUsers) appState.unsubscribeUsers();
            if (appState.unsubscribeTasks) appState.unsubscribeTasks();
        }
    });
    
    async function handleLogin(e) {
        e.preventDefault();
        const email = e.target.username.value;
        const password = e.target.password.value;
        const loginError = document.getElementById('login-error');
        loginError.classList.add('hidden'); // Hide previous errors
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            loginError.textContent = "Usuario o clave incorrectos.";
            loginError.classList.remove('hidden');
        }
    }

    window.handleLogout = function() {
        signOut(auth);
        document.getElementById('login-form').reset();
    }
    
    // --- LISTENERS DE FIRESTORE ---
    function initializeListeners() {
        if (appState.unsubscribeUsers) appState.unsubscribeUsers();
        if (appState.unsubscribeTasks) appState.unsubscribeTasks();

        if (appState.currentUser && appState.currentUser.role === 'admin') {
            const usersQuery = collection(db, "users");
            appState.unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
                appState.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminPanel();
            });
        }
        
        const tasksQuery = collection(db, "tasks");
        appState.unsubscribeTasks = onSnapshot(tasksQuery, (snapshot) => {
            appState.tasks = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                fecha_inicio: doc.data().fecha_inicio?.toDate(),
                fecha_fin: doc.data().fecha_fin?.toDate()
            }));
            renderAppForRole();
        });
    }

    function renderAppForRole() {
        if (!appState.currentUser) return;
        const user = appState.currentUser;
        document.getElementById('user-display').textContent = user.email;
        document.getElementById('role-display').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1);
        const addTramiteBtn = document.getElementById('add-tramite-btn');
        const adminPanel = document.getElementById('admin-panel');
        const exportSection = document.getElementById('export-section');
        addTramiteBtn.classList.add('hidden');
        adminPanel.classList.add('hidden');
        exportSection.classList.add('hidden');
        if (user.role === 'admin') adminPanel.classList.remove('hidden');
        if (user.role === 'auditor') { addTramiteBtn.classList.remove('hidden'); exportSection.classList.remove('hidden'); }
        renderKanbanBoard();
        updateDashboard();
        populateFilters();
        renderActiveFilters();
    }

    function renderAdminPanel() {
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        appState.users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'bg-gray-100 p-2 rounded-md flex justify-between items-center';
            li.innerHTML = `<div><span class="font-medium">${user.email}</span><span class="text-xs text-gray-500 ml-2 capitalize">${user.role}</span></div>${user.email !== 'admin@admin.com' ? `<button onclick="handleDeleteUser('${user.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>` : ''}`;
            userList.appendChild(li);
        });
    }
    
    window.handleDeleteUser = async function(userId) {
        if (confirm("¿Estás seguro de que quieres eliminar este usuario de la base de datos de roles? La cuenta de autenticación no se eliminará.")) {
             await deleteDoc(doc(db, "users", userId));
        }
    }

    async function handleCreateUser(e) {
        e.preventDefault();
        const email = e.target.new_username.value;
        const password = e.target.new_password.value;
        const role = e.target.new_role.value;
        const adminError = document.getElementById('admin-error');
        
        try {
            // This approach is insecure for production. Use Cloud Functions for user creation.
            const tempApp = initializeApp(window.firebaseConfig, `secondary-${Date.now()}`);
            const tempAuth = getAuth(tempApp);
            const userCredential = await createUserWithEmailAndPassword(tempAuth, email, password);
            await setDoc(doc(db, "users", userCredential.user.uid), { email, role });
            await signOut(tempAuth);
            
            adminError.classList.add('hidden');
            e.target.reset();
        } catch (error) {
            adminError.textContent = error.message;
            adminError.classList.remove('hidden');
        }
    }
    
    // --- LÓGICA DE LA APLICACIÓN PRINCIPAL ---

    window.handleDeleteTask = async function(taskId) {
        if (confirm("¿Estás seguro de que quieres eliminar este trámite?")) {
            await deleteDoc(doc(db, "tasks", taskId));
        }
    }

    function getFilteredTasks() {
        const { ips, tipo_actividad, estado, auditor } = appState.filters;
        return appState.tasks.filter(task => {
            const ipsMatch = !ips || task.nombre_ips === ips;
            const tipoMatch = !tipo_actividad || task.tipo_actividad === tipo_actividad;
            const estadoMatch = !estado || task.estado === estado;
            const auditorMatch = !auditor || task.nombre_auditor === auditor;
            return ipsMatch && tipoMatch && estadoMatch && auditorMatch;
        });
    }

    function renderKanbanBoard() {
        const container = document.getElementById('kanban-columns-container');
        container.innerHTML = '';
        const tasksToRender = getFilteredTasks();
        STATUSES.forEach(status => {
            const columnWrapper = document.createElement('div');
            columnWrapper.className = 'bg-gray-100 rounded-xl p-4 flex flex-col';
            const tasksInStatus = tasksToRender.filter(task => task.estado === status);
            columnWrapper.innerHTML = `<div class="flex justify-between items-center mb-4"><div class="flex items-center space-x-2"><span class="h-3 w-3 rounded-full ${STATUS_COLORS[status].indicator}"></span><h3 class="font-bold text-lg ${STATUS_COLORS[status].text}">${status}</h3></div><span class="text-sm font-bold ${STATUS_COLORS[status].text} bg-white px-2 py-1 rounded-full">${tasksInStatus.length}</span></div><div id="col-${status.replace(/\s+/g, '-')}" class="kanban-column flex-grow space-y-4 overflow-y-auto h-96 pr-2"></div>`;
            container.appendChild(columnWrapper);
            const column = document.getElementById(`col-${status.replace(/\s+/g, '-')}`);
            tasksInStatus.sort((a,b) => (b.fecha_inicio || 0) - (a.fecha_inicio || 0)).forEach(task => {
                column.appendChild(createTaskCard(task));
            });
        });
    }

    function createTaskCard(task) {
        const card = document.createElement('div');
        card.className = `p-4 rounded-lg shadow-md border-l-4 cursor-pointer hover:shadow-xl transition-shadow ${STATUS_COLORS[task.estado].bg} ${STATUS_COLORS[task.estado].border}`;
        card.setAttribute('data-task-id', task.id);
        card.onclick = () => openModal(task.id);
        let dateInfo = `<p class="text-xs text-gray-500 mt-2">Inicio: ${formatDate(task.fecha_inicio)}</p>`;
        if (task.fecha_fin) dateInfo += `<p class="text-xs text-gray-500 mt-1">Fin: ${formatDate(task.fecha_fin)}</p>`;
        card.innerHTML = `<p class="font-bold text-md ${STATUS_COLORS[task.estado].text}">${task.tipo_actividad}</p><p class="text-sm text-gray-600 mt-1">Paciente: ${task.id_paciente}</p><p class="text-sm text-gray-500 mt-1">IPS: ${task.nombre_ips}</p><p class="text-sm text-gray-500 mt-1">Auditor: ${task.nombre_auditor}</p>${dateInfo}<div class="mt-4 pt-3 border-t border-gray-200 flex flex-wrap gap-2 justify-end">${generateActionButtons(task)}</div>`;
        return card;
    }
    
    function generateActionButtons(task) {
        let buttons = '';
        const baseBtnClass = 'px-2 py-1 text-xs font-semibold rounded-md transition-colors';
        const userRole = appState.currentUser.role;
        if (userRole === 'auditor') {
            if (task.estado === 'Iniciado') buttons += `<button onclick="event.stopPropagation(); changeStatus('${task.id}', 'En Trámite')" class="${baseBtnClass} bg-blue-500 text-white hover:bg-blue-600">Poner en Trámite</button>`;
            if (task.estado !== 'Finalizado' && task.estado !== 'Cancelado') {
                buttons += `<button onclick="event.stopPropagation(); changeStatus('${task.id}', 'Finalizado')" class="${baseBtnClass} bg-green-500 text-white hover:bg-green-600">Finalizar</button>`;
                buttons += `<button onclick="event.stopPropagation(); changeStatus('${task.id}', 'Cancelado')" class="${baseBtnClass} bg-red-500 text-white hover:bg-red-600">Cancelar</button>`;
            }
        } else if (userRole === 'admin') {
            buttons += `<button onclick="event.stopPropagation(); handleDeleteTask('${task.id}')" class="${baseBtnClass} bg-gray-700 text-white hover:bg-gray-800">Eliminar Trámite</button>`;
        }
        return buttons;
    }

    function updateDashboard() {
        const tasksToDisplay = getFilteredTasks();
        document.getElementById('kpi-finalizados').textContent = appState.tasks.filter(t => t.estado === 'Finalizado').length;
        const ipsList = document.getElementById('ips-list');
        ipsList.innerHTML = '';
        const activeTasks = appState.tasks.filter(t => t.estado !== 'Finalizado' && t.estado !== 'Cancelado');
        const ipsCounts = activeTasks.reduce((acc,task) => { acc[task.nombre_ips] = (acc[task.nombre_ips] || 0) + 1; return acc; }, {});
        if(Object.keys(ipsCounts).length === 0) ipsList.innerHTML = '<li class="text-center text-gray-500">No hay trámites activos.</li>';
        else Object.entries(ipsCounts).sort((a,b) => b[1] - a[1]).forEach(([ips, count]) => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg hover:bg-gray-200 transition-colors';
            li.onclick = () => setFilter('ips', ips);
            li.innerHTML = `<span class="text-gray-700 font-medium">${ips}</span><span class="font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full text-sm">${count}</span>`;
            ipsList.appendChild(li);
        });
        const typeCounts = tasksToDisplay.reduce((acc, task) => { acc[task.tipo_actividad] = (acc[task.tipo_actividad] || 0) + 1; return acc; }, {});
        if(typeChartInstance) typeChartInstance.destroy();
        typeChartInstance = new Chart(document.getElementById('type-chart'), { type: 'doughnut', data: { labels: Object.keys(typeCounts), datasets: [{ data: Object.values(typeCounts), backgroundColor: ['#3b82f6','#10b981','#f97316','#8b5cf6','#ec4899','#f59e0b','#ef4444','#6b7280'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, onClick: (evt, elements) => { if (elements.length > 0) { const clickedLabel = typeChartInstance.data.labels[elements[0].index]; setFilter('tipo_actividad', clickedLabel); } }, plugins: { legend: { position: 'bottom' } } } });
        const statusCounts = tasksToDisplay.reduce((acc, status) => { acc[status.estado] = (acc[status.estado] || 0) + 1; return acc; }, {});
        if(statusChartInstance) statusChartInstance.destroy();
        statusChartInstance = new Chart(document.getElementById('status-chart'), { type: 'bar', data: { labels: STATUSES, datasets: [{ label: 'Nº de Trámites', data: STATUSES.map(s => statusCounts[s] || 0), backgroundColor: Object.values(STATUS_COLORS).map(c => c.indicator.replace('bg-', '#').replace('-500', '')), borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', onClick: (evt, elements) => { if (elements.length > 0) { const clickedLabel = statusChartInstance.data.labels[elements[0].index]; setFilter('estado', clickedLabel); } }, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } } });
        const auditorCounts = tasksToDisplay.reduce((acc, task) => { acc[task.nombre_auditor] = (acc[task.nombre_auditor] || 0) + 1; return acc; }, {});
        if(auditorChartInstance) auditorChartInstance.destroy();
        auditorChartInstance = new Chart(document.getElementById('auditor-chart'), { type: 'bar', data: { labels: Object.keys(auditorCounts), datasets: [{ label: 'Nº de Casos', data: Object.values(auditorCounts), backgroundColor: '#6366f1', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, onClick: (evt, elements) => { if (elements.length > 0) { const clickedLabel = auditorChartInstance.data.labels[elements[0].index]; setFilter('auditor', clickedLabel); } }, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
    }

    window.toggleForm = function() { document.getElementById('add-task-form-container').classList.toggle('hidden'); }

    async function handleAddTask(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const newTask = { 
            id_paciente: formData.get('id_paciente'), 
            nombre_paciente: formData.get('nombre_paciente') || 'N/A', 
            nombre_auditor: formData.get('nombre_auditor'), 
            nombre_ips: formData.get('nombre_ips'), 
            tipo_actividad: formData.get('tipo_actividad'), 
            descripcion_inicial: formData.get('descripcion_inicial'), 
            estado: 'Iniciado', 
            fecha_inicio: serverTimestamp(), 
            fecha_fin: null, 
            notas_seguimiento: [] 
        };
        await addDoc(collection(db, 'tasks'), newTask);
        e.target.reset();
        toggleForm();
    }

    window.changeStatus = async function(taskId, newStatus) {
        const taskRef = doc(db, "tasks", taskId);
        const updateData = { estado: newStatus };
        if (newStatus === 'Finalizado' || newStatus === 'Cancelado') {
            updateData.fecha_fin = serverTimestamp();
        } else {
            updateData.fecha_fin = null;
        }
        await updateDoc(taskRef, updateData);
    }
    
    // --- LÓGICA DE FILTROS ---
    window.setFilter = function(key, value) {
        appState.filters[key] = value;
        renderKanbanBoard();
        renderActiveFilters();
    }

    window.clearFilters = function() {
        appState.filters = { ips: null, tipo_actividad: null, estado: null, auditor: null };
        renderKanbanBoard();
        renderActiveFilters();
    }

    function renderActiveFilters() {
        const container = document.getElementById('active-filters-section');
        const list = document.getElementById('active-filters-list');
        list.innerHTML = '<h4 class="text-sm font-semibold text-gray-600">Filtros Activos:</h4>';
        const activeFilters = Object.entries(appState.filters).filter(([key, value]) => value !== null);
        if (activeFilters.length === 0) { container.classList.add('hidden'); return; }
        container.classList.remove('hidden');
        activeFilters.forEach(([key, value]) => {
            const filterTag = document.createElement('span');
            filterTag.className = 'bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full flex items-center';
            let keyText = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            filterTag.innerHTML = `<span>${keyText}: ${value}</span><button onclick="clearFilter('${key}')" class="ml-1.5 text-blue-500 hover:text-blue-700">&times;</button>`;
            list.appendChild(filterTag);
        });
    }

    window.clearFilter = function(key) { appState.filters[key] = null; renderKanbanBoard(); renderActiveFilters(); }

    window.openModal = function(taskId) {
        const task = appState.tasks.find(t => t.id === taskId); if(!task) return;
        appState.editingTaskId = taskId;
        document.getElementById('modal-status-indicator').className = `h-4 w-4 rounded-full ${STATUS_COLORS[task.estado].indicator}`;
        document.getElementById('modal-title').textContent = `Detalles: ${task.tipo_actividad}`;
        document.getElementById('modal-id-paciente').textContent = task.id_paciente;
        document.getElementById('modal-nombre-paciente').textContent = task.nombre_paciente;
        document.getElementById('modal-nombre-auditor').textContent = task.nombre_auditor;
        document.getElementById('modal-nombre-ips').textContent = task.nombre_ips;
        document.getElementById('modal-tipo-actividad').textContent = task.tipo_actividad;
        document.getElementById('modal-fecha-inicio').textContent = formatDate(task.fecha_inicio);
        document.getElementById('modal-fecha-fin').textContent = task.fecha_fin ? formatDate(task.fecha_fin) : 'Aún en curso';
        document.getElementById('modal-descripcion').textContent = task.descripcion_inicial;
        renderNotesHistory(task.notas_seguimiento);
        const addNoteSection = document.getElementById('add-note-section');
        if(appState.currentUser.role === 'auditor') addNoteSection.classList.remove('hidden');
        else addNoteSection.classList.add('hidden');
        const modal = document.getElementById('task-modal');
        modal.classList.remove('hidden');
        setTimeout(() => { modal.classList.remove('opacity-0'); modal.classList.add('scale-100'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
    }
    
    function renderNotesHistory(notes) {
        const historyContainer = document.getElementById('modal-notes-history');
        historyContainer.innerHTML = '';
        if (notes && notes.length > 0) {
            notes.slice().reverse().forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = 'bg-white p-2 rounded-md border border-gray-200';
                noteEl.innerHTML = `<p class="text-gray-800 text-sm">${note.text}</p><p class="text-xs text-gray-500 mt-1 text-right">-- ${note.author} @ ${formatDate(new Date(note.date))}</p>`;
                historyContainer.appendChild(noteEl);
            });
        } else {
            historyContainer.innerHTML = '<p class="text-center text-gray-500 text-sm">No hay notas de seguimiento.</p>';
        }
    }

    async function handleAddNote(e) {
        e.preventDefault();
        if(!appState.editingTaskId) return;
        const newNoteText = document.getElementById('modal-new-note').value.trim();
        if (newNoteText) {
            const newNote = { text: newNoteText, author: appState.currentUser.email, date: new Date().toISOString() };
            const taskRef = doc(db, "tasks", appState.editingTaskId);
            await updateDoc(taskRef, {
                notas_seguimiento: arrayUnion(newNote)
            });
            document.getElementById('modal-new-note').value = '';
        }
    }

    window.closeModal = function() {
        const modal = document.getElementById('task-modal');
        appState.editingTaskId = null; modal.classList.add('opacity-0'); modal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); }, 250);
    }
    
    function formatDate(date) { if(!date) return 'N/A'; return new Date(date).toLocaleString('es-CO', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }
    
    function formatNotesForCSV(notes) {
        if (!notes || notes.length === 0) return "";
        return notes.map(note => `(${formatDate(new Date(note.date))} por ${note.author}): ${note.text.replace(/"/g, '""')}`).join(' | ');
    }

    function formatDateForCSV(date) { if(!date) return ''; return new Date(date).toISOString(); }

    function populateFilters() {
        const monthFilter = document.getElementById('filter-month');
        const ipsFilter = document.getElementById('filter-ips');
        const auditorFilter = document.getElementById('filter-auditor');
        const months = ["Todos", "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        monthFilter.innerHTML = months.map((month, index) => `<option value="${index === 0 ? 'all' : index-1}">${month}</option>`).join('');
        const allIps = [...new Set(appState.tasks.map(task => task.nombre_ips))];
        ipsFilter.innerHTML = '<option value="all">Todas</option>' + allIps.map(ips => `<option value="${ips}">${ips}</option>`).join('');
        const allAuditors = [...new Set(appState.tasks.map(task => task.nombre_auditor))];
        auditorFilter.innerHTML = '<option value="all">Todos</option>' + allAuditors.map(auditor => `<option value="${auditor}">${auditor}</option>`).join('');
    }

    function downloadCSV() {
        const month = document.getElementById('filter-month').value; const ips = document.getElementById('filter-ips').value; const auditor = document.getElementById('filter-auditor').value;
        let filteredTasks = appState.tasks.filter(task => { const taskMonth = new Date(task.fecha_inicio).getMonth(); const monthMatch = (month === 'all') || (taskMonth == month); const ipsMatch = (ips === 'all') || (task.nombre_ips === ips); const auditorMatch = (auditor === 'all') || (task.nombre_auditor === auditor); return monthMatch && ipsMatch && auditorMatch; });
        if(filteredTasks.length === 0) { alert("No hay datos que coincidan con los filtros seleccionados."); return; }
        const headers = ["ID Trámite", "ID Paciente", "Nombre Paciente", "Nombre Auditor", "Nombre IPS", "Tipo Actividad", "Descripción Inicial", "Estado", "Fecha Inicio", "Fecha Fin", "Notas Seguimiento"];
        const csvRows = [headers.join(',')];
        filteredTasks.forEach(task => { const values = [task.id, task.id_paciente, `"${task.nombre_paciente.replace(/"/g, '""')}"`, `"${task.nombre_auditor.replace(/"/g, '""')}"`, `"${task.nombre_ips.replace(/"/g, '""')}"`, task.tipo_actividad, `"${task.descripcion_inicial.replace(/"/g, '""')}"`, task.estado, formatDateForCSV(task.fecha_inicio), formatDateForCSV(task.fecha_fin), `"${formatNotesForCSV(task.notas_seguimiento)}"`]; csvRows.push(values.join(',')); });
        const csvString = csvRows.join('\n'); const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a'); const url = URL.createObjectURL(blob); link.setAttribute('href', url); link.setAttribute('download', 'reporte_tramites.csv'); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('create-user-form').addEventListener('submit', handleCreateUser);
        document.getElementById('download-btn').addEventListener('click', downloadCSV);
        document.getElementById('add-note-form').addEventListener('submit', handleAddNote);
        document.getElementById('add-task-form').addEventListener('submit', handleAddTask);
    });
</script>
</body>
</html>
